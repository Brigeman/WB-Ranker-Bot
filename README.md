Техническое задание + современные принципы программирования для сервиса Wildberries Ranker Bot

Входные данные
	•	Файл со списком ключевых слов (пример: https://drive.google.com/file/d/12OhUuANklqqtfyjZqleenFxG-DnPPIi6/view?usp=sharing).
	•	Ссылка на товар Wildberries (пример: https://www.wildberries.ru/catalog/279266291/detail.aspx?targetUrl=MI).

1. Цель проекта

Создать Telegram-бота, который по списку ключевых слов определяет позицию заданного товара в поисковой выдаче Wildberries (до 5 страниц) и возвращает результат в виде таблицы (CSV/XLSX) с указанием:
	•	Номер строки
	•	Ключевое слово
	•	Частотность
	•	Позиция товара
	•	Цена товара

	•	время, затраченное на весь прогон.

⸻

2. Бизнес-логика
	1.	Пользователь загружает файл (CSV/XLSX или GDrive-ссылку) с ключевыми словами.
	2.	Пользователь передаёт ссылку на товар WB.
	3.	Бот извлекает nmId из ссылки.
	4.	Для каждого слова бот:
	•	ищет товар через WB API до 5 страниц,
	•	если найден — записывает позицию и цену,
	•	если нет — пропускает.
	5.	Результаты собираются в таблицу, отправляются пользователю.
	6.	Бот сообщает время выполнения.

⸻

3. Современные принципы программирования и их применение

3.1 Архитектура и структура

Принцип: Clean Architecture (ports & adapters).
Применение:
	•	ports.py описывает интерфейс SearchClient.
	•	wb_adapter.py — конкретная реализация через WB API.
	•	services.py — бизнес-логика поиска позиции.
	•	handlers.py — Telegram-логика.
→ Бот легко тестировать и расширять.

⸻

3.2 Типизация и валидация

Принцип: Сильная типизация, Pydantic-модели.
Применение:
	•	Settings (max_pages, concurrency) валидируются через Pydantic.
	•	Product(id: int, price_rub: float) — чётко описан объект.
→ Меньше багов при интеграции, строгие гарантии.

⸻

3.3 Асинхронность и устойчивость

Принцип: Async I/O + ограничение параллелизма.
Применение:
	•	aiohttp + asyncio.Semaphore(5) для ограничения запросов.
	•	Экспоненциальный бэкофф для 429/5xx.
	•	Таймауты (15 с).
→ Сервис не «ложит» WB и сам не падает при временных сбоях.

⸻

3.4 SRP и модульность

Принцип: Single Responsibility.
Применение:
	•	fileio.py отвечает только за загрузку и парсинг файлов.
	•	exporter.py — только за экспорт.
	•	ranking.py — считает позиции.
→ Код поддерживаемый и прозрачный.

⸻

3.5 Внедрение зависимостей

Принцип: Dependency Injection.
Применение:
	•	RankingService принимает на вход SearchClient.
	•	Для тестов можно подменить адаптер фейком.
→ Легко писать unit/integration тесты.

⸻

3.6 Тестирование

Принцип: Pyramid of tests.
Применение:
	•	Unit: тест парсинга nmId, чтения CSV.
	•	Integration: мок ответа WB API.
	•	Property-based (Hypothesis): проверка корректности подсчёта позиций при разных размерах страниц.
→ Гарантия корректности на краевых случаях.

⸻

3.7 Логи и метрики

Принцип: Observability.
Применение:
	•	Логирование keyword, page, time, retry_count.
	•	Метрика: среднее время на слово, % найденных.
→ Удобный анализ производительности.

⸻

3.8 Безопасность и 12-Factor

Принцип: Secrets в env, Docker-friendly.
Применение:
	•	.env с BOT_TOKEN, настройки в Pydantic Settings.
	•	Multi-stage Dockerfile, non-root user.
→ Надёжный деплой.

⸻

3.9 Чистый код

Принцип: Линт + автоформат.
Применение:
	•	pre-commit (ruff, black, mypy).
→ Единый стиль и меньше багов.

⸻

4. Обработка ошибок и ограничения

4.1 Обработка ошибок API
	•	WB API недоступен (5xx ошибки):
		◦	Экспоненциальный backoff: 1с → 2с → 4с
		◦	Максимум 3 попытки на запрос
		◦	Если все попытки неудачны → пропустить ключевое слово с пометкой "API_ERROR"
		◦	Логировать ошибку с timestamp и keyword
	•	Rate limiting (429):
		◦	Увеличить задержку между запросами до 1-2 секунд
		◦	Повторить запрос через увеличенную задержку
	•	Таймаут соединения (15с):
		◦	Повторить запрос с новой попыткой
		◦	Если превышен общий лимит времени → завершить с частичными результатами

4.2 Валидация входных данных
	•	Некорректные ссылки на товары:
		◦	Проверка формата URL Wildberries
		◦	Валидация наличия nmId в ссылке
		◦	Если nmId не найден → сообщение пользователю с примером корректной ссылки
	•	Поврежденные файлы с ключевыми словами:
		◦	Проверка формата файла (CSV/XLSX)
		◦	Валидация структуры (наличие колонки с ключевыми словами)
		◦	Если файл поврежден → запрос повторной загрузки
		◦	Частичная обработка: пропускать некорректные строки, обрабатывать валидные

4.3 Лимиты и ограничения
	•	Максимальное количество ключевых слов: 1000
		◦	При превышении → предупреждение пользователю
		◦	Возможность обработки первых 1000 слов
	•	Ограничения по времени выполнения:
		◦	Максимум 30 минут на полный прогон
		◦	При превышении → остановка с частичными результатами
		◦	Прогресс-бар с примерным временем завершения
	•	Изменение цены товара во время сканирования:
		◦	Фиксировать цену на момент первого обнаружения товара
		◦	Если товар найден на разных страницах → использовать цену с первой найденной позиции
		◦	Логировать случаи изменения цены для анализа

4.4 Пользовательские уведомления
	•	Статус выполнения:
		◦	"Обработано X из Y ключевых слов"
		◦	"Найдено товаров: Z"
		◦	"Ошибок API: N"
	•	Критические ошибки:
		◦	"Не удалось подключиться к WB API"
		◦	"Некорректная ссылка на товар"
		◦	"Файл с ключевыми словами поврежден"
	•	Предупреждения:
		◦	"Превышен лимит ключевых слов (1000)"
		◦	"Превышено время выполнения (30 мин)"

⸻

5. Технические детали реализации
	•	API Wildberries: https://search.wb.ru/exactmatch/ru/common/v4/search?query=<keyword>&page=N&resultset=catalog&sort=popular&curr=rub&lang=ru&locale=ru
	•	Цена: salePriceU / 100.
	•	Позиция: сквозная = сумма длин всех предыдущих страниц + индекс на текущей.
	•	Файл-выход: CSV (UTF-8-SIG) или XLSX.
	•	Параллелизм: до 5 запросов одновременно.
	•	Ретраи: до 3 попыток с backoff.
	•	Задержка между страницами: 50–200 мс.

⸻

6. Acceptance Criteria
	•	Бот принимает ссылку на товар, извлекает nmId.
	•	Бот принимает CSV/XLSX или GDrive-ссылку.
	•	Для каждого слова просматривает до 5 страниц.
	•	Если товар найден → корректно считает позицию и цену.
	•	Если не найден → строка отсутствует.
	•	Итоговый файл содержит корректные данные.
	•	Сообщается время выполнения.
	•	Работает в Docker.
	•	Есть unit и интеграционные тесты.
	•	Обработка ошибок API с retry логикой.
	•	Валидация входных данных с понятными сообщениями об ошибках.
	•	Соблюдение лимитов: максимум 1000 ключевых слов, 30 минут выполнения.
	•	Прогресс-бар и статус выполнения для пользователя.
	•	Логирование всех критических операций и ошибок.

⸻

7. Пример структуры проекта

wb-ranker-bot/
  app/
    bot.py
    handlers.py
    ports.py
    wb_adapter.py
    services.py
    fileio.py
    exporter.py
    config.py
    utils.py
  tests/
    test_fileio.py
    test_ranking.py
    test_wb_adapter.py
  Dockerfile
  docker-compose.yml
  requirements.txt
  README.md